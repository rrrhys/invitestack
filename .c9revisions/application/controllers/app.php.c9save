{"ts":1361407309383,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');\n\nclass App extends MY_Controller {\n\n\t/**\n\t * Index Page for this controller.\n\t *\n\t * Maps to the following URL\n\t * \t\thttp://example.com/index.php/welcome\n\t *\t- or -  \n\t * \t\thttp://example.com/index.php/welcome/index\n\t *\t- or -\n\t * Since this controller is set as the default controller in \n\t * config/routes.php, it's displayed at http://example.com/\n\t *\n\t * So any other public methods not prefixed with an underscore will\n\t * map to /index.php/welcome/<method_name>\n\t * @see http://codeigniter.com/user_guide/general/urls.html\n\t */\n\t\tpublic $facebook;\n     function __construct(){\n\t \tparent::__construct();\n\t \t$this->load->model('invitation_model','invitations');\n\t \t$this->load->helper(\"Facebook\");\n\n\t \t$this->facebook = new dFacebook(false);\n\t }\n\n\tpublic function index()\n\t{\n\t\tif($this->session->userdata('id')){\n\t\tredirect(\"/app/my_invitations\");\n\t\t}else{\n\t\t$this->landing_page();\n\t\t}\n\t}\n\tpublic function landing_page(){\n\t\techo \"Landing Page\";\n\t\t$page_data = $this->page_data_base();\n\t\t\t$page_data['page_title'] = \"\";\n\t\t\t$page_data['page_heading'] = \"\";\n\t\t\t$page_data['invitations'] = $this->invitations->list_invitations_merged();\n\t\t$this->output('app/landing_page',$page_data,'default_full_size');\t\t\t\n\t}\n\tpublic function browse_invitations(){\n\t\t$page_data = $this->page_data_base();\n\t\t\t$page_data['page_title'] = \"Browse Invitations\";\n\t\t\t$page_data['page_heading'] = \"Browse Invitations\";\n\t\t\t$page_data['invitations'] = $this->invitations->list_invitations_merged();\n\t\t$this->output('app/browse_invitations',$page_data);\t\t\t\n\t}\n\tpublic function get_ideas(){\n\t\t$page_data = $this->page_data_base();\n\t\t\t$page_data['page_title'] = \"Get Invitation Invitations\";\n\t\t\t$page_data['page_heading'] = \"Get Invitation Invitations\";\n\t\t\t$page_data['invitations'] = $this->invitations->list_customer_invitations_merged();\n\t\t$this->output('app/get_ideas',$page_data);\t\t\t\n\t}\n\tpublic function my_invitations(){\n\t\t$this->_redirect_if_not_logged_in();\n\t\t$page_data = $this->page_data_base();\n\t\t\t$page_data['page_title'] = \"Dashboard\";\n\t\t\t$page_data['page_heading'] = \"Dashboard\";\n\t\t\t$page_data['invitations'] = $this->invitations->list_invitations($this->session->userdata('id'));\n\t\t\t$page_data['my_invitations'] = $this->invitations->list_my_invitations($this->session->userdata('id'));\n\t\t$this->output('app/dashboard',$page_data);\t\t\n\t}\n\n\tpublic function get_personalised_id($base_id){\n\n\t\techo $this->invitations->get_personalised_id($base_id);\n\t}\n\tpublic function edit_personalised_invitation($invitation_id){\n\t\t$invitation = $this->invitations->get_personalised_invitation($invitation_id);\n\t\t$page_data = $this->page_data_base();\n\t\t$page_data['page_title'] = \"Personalise invitation\";\n\t\t$page_data['page_heading'] = \"Personalise Invitation\";\n\t}\n\tpublic function add_name($invitation_id,$name){\n\t\t$return_data = array();\n\t\t//add the name to the database\n\t\t$return_data['id'] = $this->invitations->add_name(urldecode($name),$invitation_id,$this->session->userdata('id'));\n\n\t\t//send back down the names block.\n\n\t\t$invitation = $this->invitations->get_personalised_invitation($invitation_id);\n\t\tif(!$invitation){\n\t\t\t$this->_invalid_page();\n\t\t}\n\t\t$names_html = \"\";\n\t\tforeach($invitation['names'] as $n){\n\t\t\n\t\t\t$base_path = \"/app/finished_invitation/{$invitation['id']}/{$n['person_name']}\";\n\t\t\t$preview_jpg = \"<a href='$base_path/jpg/' target='_blank'>(Preview:Jpg)</a>\";\n\t\t\t$preview_html = \"<a href='$base_path/html/ target='_blank'>(Preview:Html)</a>\";\n\t\t\n\t\t\t$names_html .= <<<HEREDOC\n\t\t\t\t\t\t\t\t<tr class='name_element' id='{$n['id']}'>\n\t\t\t\t\t\t\t\t\t<td>{$n['person_name']}</td>\n\t\t\t\t\t\t\t\t\t<td>{$preview_html} {$preview_jpg} <a class='remove close' id='remove_{$n['id']}'>x</a></td>\n\t\t\t\t\t\t\t\t</tr>\nHEREDOC;\n\t\t}\n\t\t$return_data['names_block'] = $names_html;\n\t\techo json_encode($return_data);\n\t}\n\tpublic function delete_name($id,$invitation_id){\n\t\treturn $this->invitations->delete_name($id,$invitation_id,$this->session->userdata('id'));\t\n\t}\n\tpublic function facebook_connect($invitation_id){\n\t//$this->load->helper('facebook');\n\t\t//send user off to connect with facebook.\n\t\tif($this->facebook->getUser()){\n\t\t\tredirect(\"/app/start_invitation_from/$invitation_id\");\n\n\t\t}else{\n\t\techo \"You need to login to facebook\";\n\t\techo \"<a href='\".$this->facebook->getLoginUrl().\"'>OK</a>\";\n\t}\n\t}\n\tpublic function start_invitation_from($invitation_id){\n\n\t\tif(!$this->session->userdata('id')){\n\t\t\t//is user logged in with facebook?\n\t\t}\n\t\t//if($this->session->userdata('id') || $this->facebook->getUser()){\n\t\t{\n\t\t\t$owner_id = $this->session->userdata('id') ? $this->session->userdata('id') : $this->facebook->getUser();\n\t\t\t$new_id = $this->invitations->start_invitation_from($invitation_id,$owner_id);\n\n\t\t\tredirect(\"/app/personalise_invitation/$new_id\");\n\t\t}\n\t\t/*else{\n\t\t\tredirect(\"/app/facebook_connect/$new_id\");\n\t\t}*/\n\t}\n\tpublic function view_invitation($invitation_id){\n\t\t\t$page_data = $this->page_data_base();\n\t\t\tif(!$this->invitations->user_owns_invitation($this->session->userdata('id'),$invitation_id)){\n\t\t\t\t$page_data['edit_disabled'] = true;\n\t\t\t}else{\n\t\t\t\t$page_data['edit_disabled'] = false;\n\t\t\t}\n\t\t\t\n\t\t\t$page_data['invitation'] = $this->invitations->get_invitation($invitation_id);\n\t\t\t$page_data['page_title'] = \"View invitation: \" . $page_data['invitation']['name'];\n\t\t\t$page_data['page_heading'] = \"View Invitation: \" . $page_data['invitation']['name'];\n\t\t\tif(!$page_data['invitation']){\n\t\t\t\t$this->_invalid_page();\n\t\t\t}\n\t\t\t$this->output('app/view_invitation',$page_data);\t\t\t\n\t}\n\tpublic function personalise_invitation($p_id){\n\t\t\t$invitation = $this->invitations->get_personalised_invitation($p_id);\n\t\t\tif(!$invitation){\n\t\t\t\t$this->_invalid_page();\n\t\t\t}\n\t\t\t$page_data = $this->page_data_base();\n\t\t\t$page_data['page_title'] = \"Personalise invitation\";\n\t\t\t$page_data['page_heading'] = \"Personalise Invitation\";\n\t\t\t/*if(!$this->invitations->user_owns_invitation($this->session->userdata('id'),$invitation_id)){\n\t\t\t\t$page_data['edit_disabled'] = true;\n\t\t\t}else{\n\t\t\t\t$page_data['edit_disabled'] = false;\n\t\t\t}*/\n\t\t\t\n\t\t\t$page_data['invitation'] = $invitation;\n\n\t\t\t$this->output('app/personalise_invitation',$page_data);\t\t\t\n\t}\n\tpublic function generic_invitation($generic_id,$name,$unique_hash=\"\",$format=\"html\",$size=\"thumb\"){\n\t\t//echo json_encode($_SERVER);\n\t\t\t$page_data = $this->page_data_base();\n\t\t\t$page_data['page_title'] = \"Generic invitation\";\n\t\t\t$page_data['page_heading'] = \"Generic Invitation\";\n\t\t\t$page_data['size'] = $size;\n\t\t$page_data['invitation'] = $this->invitations->get_invitation($generic_id);\n\t\tif(!$page_data['invitation']){\n\t\t\t$this->_invalid_page();\n\t\t}\n\t\t//overwrite the name field with that supplied.\n\t\tforeach($page_data['invitation']['fields'] as &$f){\n\t\t\tif($f['field_name'] == \"name\"){\n\t\t\t\t$f['value'] = urldecode($name);\n\t\t\t}\n\t\t}\n\t\t\n\t\t//echo json_encode($page_data);\n\t\tif($format == \"html\"){\n\t\t$this->output('app/finished_invitation',$page_data,'scripts_and_content');\n\t\t}\n\t\telse{\n\t\t\techo \"<img src='\".$this->invitations->make_generic_image_if_not_exists($generic_id,$name,$unique_hash,$size).\"'>\";\n\t\t}\n\t}\n\tpublic function finished_invitation($p_id,$name,$unique_hash=\"\",$format=\"html\",$size=\"thumb\"){\n\t\t//echo json_encode($_SERVER);\n\t\t\t$page_data = $this->page_data_base();\n\t\t\t$page_data['page_title'] = \"Personalise invitation\";\n\t\t\t$page_data['page_heading'] = \"Personalise Invitation\";\n\t\t\t$page_data['size'] = $size;\n\t\t$page_data['invitation'] = $this->invitations->get_personalised_invitation($p_id);\n\t\tif(!$page_data['invitation']){\n\t\t\t$this->_invalid_page();\n\t\t}\n\t\t//overwrite the name field with that supplied.\n\t\tforeach($page_data['invitation']['fields'] as &$f){\n\t\t\tif($f['field_name'] == \"name\"){\n\t\t\t\t$f['value'] = urldecode($name);\n\t\t\t}\n\t\t}\n\t\t\n\t\t//echo json_encode($page_data);\n\t\tif($format == \"html\"){\n\t\t$this->output('app/finished_invitation',$page_data,'scripts_and_content');\n\t\t}\n\t\telse{\n\t\t\techo \"<img src='\".$this->invitations->make_image_if_not_exists($p_id,$name,$unique_hash,$size).\"'>\";\n\t\t}\n\t}\n\tpublic function save_personalised_invitation($id){\n\t\t$invitation = array();\n\t\t$invitation['invitation_html'] = $this->input->post('invitation_html');\n\t\t$invitation['fields']= array();\n\t\t\tforeach($_POST as $k=>$v){\n\t\t\t\tif(substr($k, 0,12) == \"input_merge_\"){\n\t\t\t\t\t$k = substr($k,12);\n\t\t\t\t\t$invitation['fields'][$k] = array(\n\t\t\t\t\t\t\t\t\t\t\t\t\t'value' => $v,\n\t\t\t\t\t\t\t\t\t\t\t\t\t'type'=>\"merge\");\n\t\t\t\t}\n\t\t\t\tif(substr($k, 0,15) == \"input_template_\"){\n\t\t\t\t\t$k = substr($k,15);\n\t\t\t\t\t$invitation['fields'][$k] = array(\n\t\t\t\t\t\t\t\t\t\t\t\t\t'value' => $v,\n\t\t\t\t\t\t\t\t\t\t\t\t\t'type'=>\"template\");\n\t\t\t\t}\n\t\t\t}\n\t\t$this->invitations->update_personalised_invitation($id,$invitation);\n\n\t\tredirect(\"/app/personalise_invitation/$id\");\n\t\t\n\t}\n\tpublic function edit_invitation($invitation_id){\n\t\t$this->_redirect_if_not_logged_in();\n\t\tif(!$this->input->post(\"submitted\")){\n\t\t\t$page_data = $this->page_data_base();\n\t\t\t$page_data['page_title'] = \"Edit invitation\";\n\t\t\t$page_data['page_heading'] = \"Edit Invitation\";\n\t\t\t$page_data['edit_disabled'] = false;\n\t\t\t$page_data['invitation'] = $this->invitations->get_invitation($invitation_id);\n\t\t\t$this->output('app/edit_invitation',$page_data);\n\t\t\t}else{\n\t\t\t$invitation = array();\n\t\t\t$invitation['name'] = $this->input->post('name');\n\t\t\t$invitation['invitation_html'] = $this->input->post('invitation_html');\n\t\t\t$invitation['fields']= array();\n\t\t\tforeach($_POST as $k=>$v){\n\t\t\t\tif(substr($k, 0,12) == \"input_merge_\"){\n\t\t\t\t\t$k = substr($k,12);\n\t\t\t\t\t$invitation['fields'][$k] = array(\n\t\t\t\t\t\t\t\t\t\t\t\t\t'value' => $v,\n\t\t\t\t\t\t\t\t\t\t\t\t\t'type'=>\"merge\");\n\t\t\t\t}\n\t\t\t\tif(substr($k, 0,15) == \"input_template_\"){\n\t\t\t\t\t$k = substr($k,15);\n\t\t\t\t\t$invitation['fields'][$k] = array(\n\t\t\t\t\t\t\t\t\t\t\t\t\t'value' => $v,\n\t\t\t\t\t\t\t\t\t\t\t\t\t'type'=>\"template\");\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t\tif(!$this->invitations->user_owns_invitation($this->session->userdata('id'),$invitation_id)){\n\t\t\t\t\t\t$this->session->set_flashdata('bad',\"User cannot edit that invitation.\");\n\t\t\t\t\t\tredirect(\"/app/my_invitations\");\t\n\t\t\t\t}else if ($this->invitations->update_invitation($invitation_id,$invitation)){\n\t\t\t\t\t\t$this->session->set_flashdata('good','Invitation edited successfully.');\n\t\t\t\t\t\tredirect(\"/app/my_invitations\");\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t\t$this->session->set_flashdata('bad',implode(\"<br />\", $this->timeclock->errors));\n\t\t\t\t\t\tredirect(\"app/edit_invitation/\" . $job_id);\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\t\n\t}\n\tpublic function new_invitation(){\n\t\t$this->_redirect_if_not_logged_in();\n\t\tif(!$this->input->post(\"submitted\")){\n\t\t\t$page_data = $this->page_data_base();\n\t\t\t$page_data['page_title'] = \"Add a new invitation\";\n\t\t\t$page_data['page_heading'] = \"New Invitation\";\n\t\t\t\n\t\t\t$this->output('app/new_invitation',$page_data);\t\t\n\t\t}else{\n\t\t\tif($this->invitations->add_invitation($this->session->userdata('id'),\n\t\t\tarray(\t'name'=>$this->input->post(\"name\"),\n\t\t\t\t\t'invitation_html'=>$this->input->post(\"invitation_html\"),\n\t\t\t\t\t'orientation'=>$this->input->post(\"orientation\")))){\n\t\t\t\t\t\t$this->session->set_flashdata('good','New Invitation added.');\n\t\t\t\t\t\tredirect(\"/app/my_invitations\");\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t$this->session->set_flashdata('bad',implode(\"<br />\", $this->invitations->errors));\n\t\t\t\t\t\tredirect(\"app/new_invitation\");\n\t\t\t\t\t}\n\t\t}\n\t}\n}\n\n/* End of file welcome.php */\n/* Location: ./application/controllers/welcome.php */"]],"start1":0,"start2":0,"length1":0,"length2":11235}]],"length":11235}
